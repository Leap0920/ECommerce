@{
    ViewBag.Title = "My Orders";
}

<div class="section" style="max-width: 1000px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2rem;">My Orders</h1>
        <div class="form-group" style="margin: 0;">
            <select id="order-filter" class="form-control" onchange="filterOrders()">
                <option value="all">All Orders</option>
                <option value="30">Last 30 Days</option>
                <option value="365">This Year</option>
            </select>
        </div>
    </div>

    <div id="orders-container" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div style="text-align: center; padding: 3rem;">
            <i class="ph ph-spinner" style="font-size: 2.5rem; color: var(--primary); animation: spin 1s linear infinite;"></i>
            <p style="margin-top: 1rem; color: var(--text-muted);">Loading your orders...</p>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div id="review-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 500px; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2>Write a Review</h2>
            <button onclick="closeReviewModal()" class="icon-btn"><i class="ph ph-x"></i></button>
        </div>
        <form id="review-form" onsubmit="submitReview(event)">
            <input type="hidden" id="review-product-id">
            <input type="hidden" id="review-order-id">
            
            <div id="review-product-info" style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-alt); border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                <!-- Product info will be loaded here -->
            </div>
            
            <div class="form-group">
                <label class="form-label">Rating</label>
                <div id="star-rating" style="display: flex; gap: 0.5rem;">
                    <button type="button" class="star-btn" onclick="setRating(1)"><i class="ph ph-star" data-star="1" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer;"></i></button>
                    <button type="button" class="star-btn" onclick="setRating(2)"><i class="ph ph-star" data-star="2" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer;"></i></button>
                    <button type="button" class="star-btn" onclick="setRating(3)"><i class="ph ph-star" data-star="3" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer;"></i></button>
                    <button type="button" class="star-btn" onclick="setRating(4)"><i class="ph ph-star" data-star="4" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer;"></i></button>
                    <button type="button" class="star-btn" onclick="setRating(5)"><i class="ph ph-star" data-star="5" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer;"></i></button>
                </div>
                <input type="hidden" id="review-rating" value="0">
            </div>
            
            <div class="form-group">
                <label class="form-label">Your Review</label>
                <textarea id="review-text" class="form-control" rows="4" placeholder="Share your experience with this product..." required></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" onclick="closeReviewModal()" class="btn btn-outline" style="flex: 1;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Submit Review</button>
            </div>
        </form>
    </div>
</div>

<!-- Invoice Modal -->
<div id="invoice-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 600px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2><i class="ph ph-file-text" style="margin-right: 0.5rem;"></i> Invoice</h2>
            <button onclick="closeInvoiceModal()" class="icon-btn"><i class="ph ph-x"></i></button>
        </div>
        <div id="invoice-content">
            <!-- Invoice content will be loaded here -->
        </div>
    </div>
</div>

<style>
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .star-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
    }
    .star-btn:hover i, .star-btn i.active {
        color: #f59e0b !important;
    }
</style>

<script>
    let orders = [];
    let currentRating = 0;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
    });
    
    async function loadOrders() {
        const container = document.getElementById('orders-container');
        
        try {
            const response = await fetch('/api/orders/user');
            const result = await response.json();
            
            if (result.success && result.data && result.data.length > 0) {
                orders = result.data;
                renderOrders(orders);
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <i class="ph ph-package" style="font-size: 4rem; color: var(--text-muted); opacity: 0.5;"></i>
                        <h3 style="margin-top: 1rem; color: var(--text-muted);">No orders yet</h3>
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Start shopping to see your orders here!</p>
                        <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Browse Products</a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: red;">
                    <i class="ph ph-warning" style="font-size: 3rem;"></i>
                    <p style="margin-top: 1rem;">Error loading orders. Please try again.</p>
                </div>
            `;
        }
    }
    
    function filterOrders() {
        const filter = document.getElementById('order-filter').value;
        const now = new Date();
        
        let filtered = orders;
        if (filter !== 'all') {
            const days = parseInt(filter);
            const cutoff = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
            filtered = orders.filter(o => new Date(o.OrderDate) >= cutoff);
        }
        
        renderOrders(filtered);
    }
    
    function renderOrders(data) {
        const container = document.getElementById('orders-container');
        
        if (data.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <i class="ph ph-funnel" style="font-size: 3rem; color: var(--text-muted); opacity: 0.5;"></i>
                    <p style="margin-top: 1rem; color: var(--text-muted);">No orders found for this period.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        data.forEach(order => {
            const orderDate = new Date(order.OrderDate);
            const formattedDate = orderDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const statusColors = {
                'Pending': 'background: #fef3c7; color: #92400e;',
                'Processing': 'background: #dbeafe; color: #1e40af;',
                'Shipped': 'background: #e0e7ff; color: #4338ca;',
                'Delivered': 'background: #dcfce7; color: #166534;',
                'Cancelled': 'background: #fee2e2; color: #991b1b;'
            };
            
            // Calculate estimated delivery (3-5 days from order for demo)
            const deliveryDate = new Date(orderDate.getTime() + (4 * 24 * 60 * 60 * 1000));
            const deliveryText = order.Status === 'Delivered' 
                ? `Delivered ${deliveryDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                : order.Status === 'Cancelled'
                    ? 'Cancelled'
                    : order.Status === 'Shipped'
                        ? `Est. delivery ${deliveryDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                        : order.Status;
            
            let itemsHtml = '';
            if (order.Items && order.Items.length > 0) {
                order.Items.forEach(item => {
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-top: 1px solid var(--border);">
                            <div style="display: flex; gap: 1.5rem; align-items: center;">
                                <div style="position: relative;">
                                    <img src="${item.ProductImage || '/Content/Images/placeholder.jpg'}" onerror="this.src='/Content/Images/placeholder.jpg'" style="width: 80px; height: 80px; object-fit: contain; border-radius: var(--radius-sm); background: var(--bg-alt);">
                                </div>
                                <div>
                                    <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">${item.ProductName}</h3>
                                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Qty: ${item.Quantity} Ã— \u20B1${item.Price.toFixed(2)}</p>
                                    <span style="${statusColors[order.Status] || ''} padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 600;">${deliveryText}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                ${order.Status === 'Delivered' ? `
                                    <button class="btn btn-outline" style="font-size: 0.875rem;" onclick="openReviewModal('${order.Id}', ${item.ProductId}, '${item.ProductName}', '${item.ProductImage || ''}')">
                                        <i class="ph ph-star" style="margin-right: 0.25rem;"></i> Review
                                    </button>
                                ` : ''}
                                <button class="btn btn-primary" style="font-size: 0.875rem;" onclick="buyAgain(${item.ProductId})">Buy Again</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            const orderCard = document.createElement('div');
            orderCard.className = 'card';
            orderCard.style.padding = '1.5rem';
            orderCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 0;">
                    <div style="display: flex; gap: 2rem;">
                        <div>
                            <p style="font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem;">Order Placed</p>
                            <span style="font-weight: 600;">${formattedDate}</span>
                        </div>
                        <div>
                            <p style="font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem;">Total</p>
                            <span style="font-weight: 600;">\u20B1${order.Total.toFixed(2)}</span>
                        </div>
                        <div>
                            <p style="font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem;">Ship To</p>
                            <span style="font-weight: 600; color: var(--primary);">${order.CustomerName}</span>
                        </div>
                    </div>
                    <div>
                        <p style="font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem; text-align: right;">Order # ${order.Id}</p>
                        <div style="display: flex; gap: 1rem;">
                            <a href="javascript:void(0)" onclick="viewInvoice('${order.Id}')" style="color: var(--primary); font-weight: 500;">View Invoice</a>
                        </div>
                    </div>
                </div>
                ${itemsHtml}
            `;
            container.appendChild(orderCard);
        });
    }
    
    async function buyAgain(productId) {
        try {
            // Add to cart via API (uses form-urlencoded for MVC binding)
            const response = await fetch('/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + encodeURIComponent(productId) + '&quantity=1'
            });
            const result = await response.json();
            
            if (result.success) {
                // Trigger cart update event
                window.dispatchEvent(new Event('cartUpdated'));
                
                // Show success and redirect
                if (confirm('Product added to cart! Go to cart now?')) {
                    window.location.href = '@Url.Action("Index", "Cart")';
                }
            } else {
                alert('Failed to add to cart: ' + result.message);
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            alert('Error adding product to cart');
        }
    }
    
    function openReviewModal(orderId, productId, productName, productImage) {
        document.getElementById('review-order-id').value = orderId;
        document.getElementById('review-product-id').value = productId;
        document.getElementById('review-product-info').innerHTML = `
            <img src="${productImage || '/Content/Images/placeholder.jpg'}" onerror="this.src='/Content/Images/placeholder.jpg'" style="width: 60px; height: 60px; object-fit: contain; border-radius: var(--radius-sm);">
            <div>
                <h4 style="margin-bottom: 0.25rem;">${productName}</h4>
                <p style="font-size: 0.875rem; color: var(--text-muted);">Order #${orderId}</p>
            </div>
        `;
        currentRating = 0;
        updateStars(0);
        document.getElementById('review-text').value = '';
        document.getElementById('review-modal').style.display = 'flex';
    }
    
    function closeReviewModal() {
        document.getElementById('review-modal').style.display = 'none';
    }
    
    function setRating(rating) {
        currentRating = rating;
        document.getElementById('review-rating').value = rating;
        updateStars(rating);
    }
    
    function updateStars(rating) {
        document.querySelectorAll('#star-rating i').forEach(star => {
            const starValue = parseInt(star.getAttribute('data-star'));
            if (starValue <= rating) {
                star.classList.remove('ph-star');
                star.classList.add('ph-star-fill');
                star.style.color = '#f59e0b';
            } else {
                star.classList.remove('ph-star-fill');
                star.classList.add('ph-star');
                star.style.color = '#d1d5db';
            }
        });
    }
    
    function submitReview(event) {
        event.preventDefault();
        
        const rating = currentRating;
        const review = document.getElementById('review-text').value;
        const productId = document.getElementById('review-product-id').value;
        const orderId = document.getElementById('review-order-id').value;
        
        if (rating === 0) {
            alert('Please select a rating');
            return;
        }
        
        // For now, just show success (you can implement actual review storage later)
        alert('Thank you for your review! Your feedback helps other customers make informed decisions.');
        closeReviewModal();
    }
    
    function viewInvoice(orderId) {
        const order = orders.find(o => o.Id === orderId);
        if (!order) return;
        
        const orderDate = new Date(order.OrderDate);
        const formattedDate = orderDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        
        let itemsHtml = '';
        if (order.Items && order.Items.length > 0) {
            order.Items.forEach((item, index) => {
                itemsHtml += `
                    <tr style="${index < order.Items.length - 1 ? 'border-bottom: 1px solid var(--border);' : ''}">
                        <td style="padding: 0.75rem 0;">${item.ProductName}</td>
                        <td style="padding: 0.75rem 0; text-align: center;">${item.Quantity}</td>
                        <td style="padding: 0.75rem 0; text-align: right;">\u20B1${item.Price.toFixed(2)}</td>
                        <td style="padding: 0.75rem 0; text-align: right; font-weight: 600;">\u20B1${item.TotalPrice.toFixed(2)}</td>
                    </tr>
                `;
            });
        }
        
        document.getElementById('invoice-content').innerHTML = `
            <div id="printable-invoice">
                <!-- Invoice Header -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid var(--primary);">
                    <div>
                        <h2 style="font-size: 1.75rem; color: var(--primary); margin-bottom: 0.25rem;">
                            <i class="ph-fill ph-plant"></i> FreshMarket
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Fresh, Organic, Delivered</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-size: 0.875rem; color: var(--text-muted);">Invoice #</p>
                        <p style="font-weight: 700; font-size: 1.1rem;">${order.Id}</p>
                        <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">Date: ${formattedDate}</p>
                    </div>
                </div>
                
                <!-- Bill To / Ship To -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <p style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem;">Bill To</p>
                        <p style="font-weight: 600;">${order.CustomerName}</p>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">${order.CustomerEmail}</p>
                    </div>
                    <div>
                        <p style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem;">Ship To</p>
                        <p style="font-weight: 600;">${order.CustomerName}</p>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">${order.ShippingAddress || 'N/A'}</p>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">${order.City || ''} ${order.State || ''} ${order.ZipCode || ''}</p>
                    </div>
                </div>
                
                <!-- Order Items -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;">
                    <thead>
                        <tr style="background: var(--bg-alt); border-radius: var(--radius-sm);">
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Product</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Qty</th>
                            <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Price</th>
                            <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                
                <!-- Totals -->
                <div style="display: flex; justify-content: flex-end;">
                    <div style="width: 250px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Subtotal</span>
                            <span>\u20B1${order.Subtotal.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">VAT (12%)</span>
                            <span>\u20B1${order.Tax.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 0.75rem; border-top: 2px solid var(--border); font-weight: 700; font-size: 1.1rem;">
                            <span>Total</span>
                            <span style="color: var(--primary);">\u20B1${order.Total.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border); text-align: center;">
                    <p style="color: var(--text-muted); font-size: 0.875rem;">Thank you for shopping with FreshMarket!</p>
                    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem;">Questions? Contact us at support@freshmarket.com</p>
                </div>
            </div>
        `;
        
        document.getElementById('invoice-modal').style.display = 'flex';
    }
    
    function closeInvoiceModal() {
        document.getElementById('invoice-modal').style.display = 'none';
    }
    
    // Close modals when clicking outside
    document.getElementById('review-modal').addEventListener('click', function(e) {
        if (e.target === this) closeReviewModal();
    });
    document.getElementById('invoice-modal').addEventListener('click', function(e) {
        if (e.target === this) closeInvoiceModal();
    });
</script>
