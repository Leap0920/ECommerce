@{
    ViewBag.Title = "My Account";
}

<div style="max-width: 1000px; margin: 0 auto; padding: 2rem 0;">
    <!-- Welcome Section -->
    <div class="card" style="padding: 2rem; margin-bottom: 2rem; background: var(--gradient-primary); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="font-size: 1.75rem; margin-bottom: 0.5rem;" id="welcome-name">Welcome back!</h1>
                <p style="color: rgba(255,255,255,0.85); font-size: 0.95rem;" id="user-email">Loading...</p>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="@Url.Action("Orders", "Customer")" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    <i class="ph-bold ph-package" style="margin-right: 0.5rem;"></i> My Orders
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
        <a href="@Url.Action("Index", "Home")" class="card" style="padding: 1.5rem; text-align: center; text-decoration: none; transition: transform 0.2s;">
            <div style="width: 50px; height: 50px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #166534;">
                <i class="ph-fill ph-storefront" style="font-size: 1.5rem;"></i>
            </div>
            <h3 style="color: var(--text-main); margin-bottom: 0.25rem;">Shop</h3>
            <p style="color: var(--text-muted); font-size: 0.875rem;">Browse products</p>
        </a>

        <a href="@Url.Action("Index", "Cart")" class="card" style="padding: 1.5rem; text-align: center; text-decoration: none; transition: transform 0.2s;">
            <div style="width: 50px; height: 50px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #92400e;">
                <i class="ph-fill ph-shopping-cart" style="font-size: 1.5rem;"></i>
            </div>
            <h3 style="color: var(--text-main); margin-bottom: 0.25rem;">Cart</h3>
            <p style="color: var(--text-muted); font-size: 0.875rem;">View your cart</p>
        </a>

        <a href="@Url.Action("Orders", "Customer")" class="card" style="padding: 1.5rem; text-align: center; text-decoration: none; transition: transform 0.2s;">
            <div style="width: 50px; height: 50px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #1e40af;">
                <i class="ph-fill ph-package" style="font-size: 1.5rem;"></i>
            </div>
            <h3 style="color: var(--text-main); margin-bottom: 0.25rem;">Orders</h3>
            <p style="color: var(--text-muted); font-size: 0.875rem;">Track your orders</p>
        </a>
    </div>

    <!-- Recent Orders -->
    <div class="card" style="padding: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.25rem;">Recent Orders</h2>
            <a href="@Url.Action("Orders", "Customer")" style="color: var(--primary); font-weight: 500; text-decoration: none;">View All â†’</a>
        </div>

        <div id="orders-container">
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                <i class="ph ph-spinner" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                <p style="margin-top: 1rem;">Loading orders...</p>
            </div>
        </div>
    </div>
</div>

<style>
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .card:hover {
        transform: translateY(-2px);
    }
</style>

<script>
    // Check if user is logged in
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/api/auth/current');
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('welcome-name').textContent = 'Welcome back, ' + result.data.name + '!';
                document.getElementById('user-email').textContent = result.data.email;
                
                // Load user orders
                loadOrders();
            } else {
                // Not logged in, redirect to sign in
                window.location.href = '@Url.Action("SignIn", "Regis")';
            }
        } catch (error) {
            console.error('Auth check error:', error);
            // Check localStorage as fallback
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('welcome-name').textContent = 'Welcome back, ' + user.firstName + ' ' + user.lastName + '!';
                document.getElementById('user-email').textContent = user.email;
                loadOrders();
            } else {
                window.location.href = '@Url.Action("SignIn", "Regis")';
            }
        }
    });

    async function loadOrders() {
        const container = document.getElementById('orders-container');
        
        try {
            console.log('[Dashboard] Loading user orders...');
            const response = await fetch('/api/orders/user');
            const result = await response.json();
            console.log('[Dashboard] Orders API response:', result);
            
            if (result.success && result.data && result.data.length > 0) {
                console.log('[Dashboard] Found', result.data.length, 'orders');
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="border-bottom: 1px solid var(--border); text-align: left;">';
                html += '<th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Order ID</th>';
                html += '<th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Date</th>';
                html += '<th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Total</th>';
                html += '<th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Status</th>';
                html += '</tr></thead><tbody>';
                
                result.data.slice(0, 5).forEach(order => {
                    const date = new Date(order.OrderDate).toLocaleDateString();
                    const statusColors = {
                        'Pending': 'background: #fef3c7; color: #92400e;',
                        'Processing': 'background: #dbeafe; color: #1e40af;',
                        'Shipped': 'background: #e0e7ff; color: #4338ca;',
                        'Delivered': 'background: #dcfce7; color: #166534;',
                        'Cancelled': 'background: #fee2e2; color: #991b1b;'
                    };
                    
                    html += '<tr style="border-bottom: 1px solid var(--border);">';
                    html += '<td style="padding: 1rem 0; font-family: monospace;">' + order.Id + '</td>';
                    html += '<td style="padding: 1rem 0;">' + date + '</td>';
                    html += '<td style="padding: 1rem 0; font-weight: 600;">&#8369;' + order.Total.toFixed(2) + '</td>';
                    html += '<td style="padding: 1rem 0;"><span style="' + (statusColors[order.Status] || '') + ' padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 500;">' + order.Status + '</span></td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } else {
                console.log('[Dashboard] No orders found or API error:', result.message);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="ph ph-package" style="font-size: 3rem; opacity: 0.5;"></i><p style="margin-top: 1rem;">No orders yet. Start shopping!</p><a href="' + '@Url.Action("Index", "Home")' + '" class="btn btn-primary" style="margin-top: 1rem;">Browse Products</a></div>';
            }
        } catch (error) {
            console.error('[Dashboard] Error loading orders:', error);
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>Unable to load orders.</p></div>';
        }
    }

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
            localStorage.removeItem('user');
            window.location.href = '@Url.Action("Index", "Home")';
        } catch (error) {
            console.error('Logout error:', error);
            localStorage.removeItem('user');
            window.location.href = '@Url.Action("Index", "Home")';
        }
    }
</script>
