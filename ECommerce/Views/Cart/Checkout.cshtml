@{
    ViewBag.Title = "Checkout";
}

<div class="section" style="max-width: 1100px; margin: 0 auto;">
    <div style="margin-bottom: 2rem; text-align: center;">
        <h1 style="font-size: 2rem; margin-bottom: 0.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Checkout</h1>
        <p style="color: var(--text-muted);">Complete your order</p>
    </div>
    
    <!-- Error Container -->
    <div id="checkout-error" style="display: none; padding: 1rem; background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; border-radius: 8px; margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="ph ph-warning-circle" style="font-size: 1.25rem;"></i>
            <span id="error-message"></span>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem;">
        <!-- Checkout Form -->
        <div style="display: flex; flex-direction: column; gap: 2rem;">
            <!-- Contact Info -->
            <div class="card" style="padding: 2rem; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gradient-primary);"></div>
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                    <div style="width: 32px; height: 32px; background: var(--gradient-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700;">1</div>
                    Contact Information
                </h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">First Name <span style="color: red;">*</span></label>
                        <input type="text" id="fname" class="form-control vue-input" placeholder="Juan" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name <span style="color: red;">*</span></label>
                        <input type="text" id="lname" class="form-control vue-input" placeholder="Dela Cruz" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Email Address <span style="color: red;">*</span></label>
                        <input type="email" id="email" class="form-control vue-input" placeholder="juan@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Number <span style="color: red;">*</span></label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.875rem;">+63</span>
                            <input type="tel" id="phone" class="form-control" placeholder="9XX XXX XXXX" style="padding-left: 3rem;" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Info -->
            <div class="card" style="padding: 2rem; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></div>
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700;">2</div>
                    Shipping Address
                </h3>
                
                <div class="form-group">
                    <label class="form-label">Complete Address <span style="color: red;">*</span></label>
                    <input type="text" id="address" class="form-control vue-input" placeholder="House/Unit No., Street, Subdivision/Village" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Barangay <span style="color: red;">*</span></label>
                        <input type="text" id="barangay" class="form-control" placeholder="Barangay" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">City / Municipality <span style="color: red;">*</span></label>
                        <input type="text" id="city" class="form-control" placeholder="Quezon City" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Province <span style="color: red;">*</span></label>
                        <select id="province" class="form-control" required>
                            <option value="">Select Province</option>
                            <option value="Metro Manila">Metro Manila</option>
                            <option value="Cavite">Cavite</option>
                            <option value="Laguna">Laguna</option>
                            <option value="Batangas">Batangas</option>
                            <option value="Rizal">Rizal</option>
                            <option value="Bulacan">Bulacan</option>
                            <option value="Pampanga">Pampanga</option>
                            <option value="Cebu">Cebu</option>
                            <option value="Davao del Sur">Davao del Sur</option>
                            <option value="Iloilo">Iloilo</option>
                            <option value="Negros Occidental">Negros Occidental</option>
                            <option value="Pangasinan">Pangasinan</option>
                            <option value="Zambales">Zambales</option>
                            <option value="Other">Other Province</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Postal Code <span style="color: red;">*</span></label>
                        <input type="text" id="zip" class="form-control" placeholder="1105" required>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 0.5rem;">
                    <label class="form-label">Delivery Notes (Optional)</label>
                    <textarea id="notes" class="form-control" rows="2" placeholder="Landmarks, special instructions for the rider..."></textarea>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="card" style="padding: 2rem; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"></div>
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700;">3</div>
                    Payment Method
                </h3>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- COD Option -->
                    <label class="payment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="payment" value="cod" checked style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <i class="ph-fill ph-money" style="font-size: 1.25rem; color: var(--primary);"></i>
                                <span style="font-weight: 600;">Cash on Delivery (COD)</span>
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">Pay when you receive your order</p>
                        </div>
                        <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">RECOMMENDED</span>
                    </label>

                    <!-- GCash Option -->
                    <label class="payment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="payment" value="gcash" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <i class="ph-fill ph-wallet" style="font-size: 1.25rem; color: #007dfe;"></i>
                                <span style="font-weight: 600;">GCash</span>
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">Pay using your GCash wallet</p>
                        </div>
                    </label>

                    <!-- Maya Option -->
                    <label class="payment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="payment" value="maya" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <i class="ph-fill ph-credit-card" style="font-size: 1.25rem; color: #00d68f;"></i>
                                <span style="font-weight: 600;">Maya / PayMaya</span>
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">Pay using your Maya wallet or card</p>
                        </div>
                    </label>

                    <!-- Bank Transfer Option -->
                    <label class="payment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="payment" value="bank" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <i class="ph-fill ph-bank" style="font-size: 1.25rem; color: #1e40af;"></i>
                                <span style="font-weight: 600;">Bank Transfer</span>
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">BDO, BPI, Metrobank, UnionBank</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div style="position: sticky; top: 100px; display: flex; flex-direction: column; gap: 1.5rem; align-self: flex-start;">
            <div class="card" style="padding: 2rem;">
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ph ph-shopping-bag" style="color: var(--primary);"></i>
                    Order Summary
                </h3>
                <div id="checkout-items" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; max-height: 250px; overflow-y: auto;">
                    <!-- Items injected via JS -->
                </div>

                <div style="height: 1px; background: var(--border); margin-bottom: 1.5rem;"></div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                    <span style="color: var(--text-muted);">Subtotal</span>
                    <span id="chk-subtotal" style="font-weight: 600;">&#8369;0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                    <span style="color: var(--text-muted);">Shipping Fee</span>
                    <span id="chk-shipping" style="font-weight: 600;">&#8369;0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                    <span style="color: var(--text-muted);">VAT (12%)</span>
                    <span id="chk-tax" style="font-weight: 600;">&#8369;0.00</span>
                </div>
                
                <div style="height: 1px; background: var(--border); margin: 1rem 0;"></div>
                
                <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700;">
                    <span>Total</span>
                    <span id="chk-total" style="color: var(--primary);">&#8369;0.00</span>
                </div>

                <button id="place-order-btn" class="btn btn-primary vue-btn" style="width: 100%; margin-top: 1.5rem; padding: 1rem; font-size: 1rem;" data-vue-btn="checkout-place-order">
                    <i class="ph-bold ph-check-circle" style="margin-right: 0.5rem;"></i>
                    Place Order
                </button>
                
                <p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-top: 1rem;">
                    By placing this order, you agree to our <a href="#" style="color: var(--primary);">Terms & Conditions</a>
                </p>
            </div>

            <!-- Shipping Info Card -->
            <div class="card" style="padding: 1.5rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <i class="ph-fill ph-truck" style="font-size: 1.5rem; color: #166534;"></i>
                    <span style="font-weight: 600; color: #166534;">Free Shipping</span>
                </div>
                <p style="font-size: 0.8rem; color: #166534; margin: 0;">
                    Orders above &#8369;1,500 qualify for FREE shipping within Metro Manila!
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="padding: 3rem; text-align: center; max-width: 500px;">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: #166534;">
            <i class="ph-fill ph-check-circle" style="font-size: 3rem;"></i>
        </div>
        <h2 style="margin-bottom: 0.5rem; color: #166534;">Order Placed Successfully!</h2>
        <p style="color: var(--text-muted); margin-bottom: 0.5rem;">Salamat sa iyong order!</p>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
            Order ID: <strong id="order-id-display" style="color: var(--primary);"></strong>
        </p>

        <div style="display: flex; gap: 1rem;">
            <a href="@Url.Action("Dashboard", "Customer")" class="btn btn-outline" style="flex: 1;">Go to Dashboard</a>
            <a href="@Url.Action("Orders", "Customer")" class="btn btn-primary vue-btn" onclick="finishCheckout()" style="flex: 1;" data-vue-btn="checkout-continue">View My Orders</a>
        </div>
    </div>
</div>

<!-- Authentication Required Modal -->
<div id="auth-modal" class="auth-modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card auth-modal-card" style="padding: 3rem; text-align: center; max-width: 450px; position: relative;">
        <div class="auth-modal-icon" style="width: 80px; height: 80px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: #92400e;">
            <i class="ph-fill ph-lock" style="font-size: 2.5rem;"></i>
        </div>
        <h2 style="margin-bottom: 0.5rem; color: var(--text-main);">Sign In Required</h2>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6;">
            Please sign in or create an account to complete your purchase. Don't worry, your cart items are saved!
        </p>
        
        <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #166534;">
                <i class="ph-fill ph-shopping-cart" style="font-size: 1.25rem;"></i>
                <span style="font-weight: 600;">Your cart (<span id="auth-cart-count">0</span> items) is safe!</span>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="@Url.Action("SignIn", "Regis")?returnUrl=@Url.Action("Checkout", "Cart")" class="btn btn-primary vue-btn" style="width: 100%; padding: 1rem;">
                <i class="ph-bold ph-sign-in" style="margin-right: 0.5rem;"></i>
                Sign In
            </a>
            <a href="@Url.Action("Register", "Regis")?returnUrl=@Url.Action("Checkout", "Cart")" class="btn btn-outline" style="width: 100%; padding: 1rem;">
                <i class="ph-bold ph-user-plus" style="margin-right: 0.5rem;"></i>
                Create Account
            </a>
        </div>
        
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            <a href="@Url.Action("Index", "Cart")" style="color: var(--text-muted); font-size: 0.875rem; text-decoration: none;">
                <i class="ph ph-arrow-left" style="margin-right: 0.25rem;"></i>
                Back to Cart
            </a>
        </div>
    </div>
</div>

<style>
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Auth Modal Animations */
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @@keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        to { 
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    @@keyframes shake {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
    }
    
    .auth-modal-backdrop {
        animation: fadeIn 0.3s ease-out forwards;
    }
    
    .auth-modal-card {
        animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    
    .auth-modal-icon {
        animation: pulse 2s ease-in-out infinite;
    }
    
    .auth-modal-icon i {
        animation: shake 0.5s ease-in-out;
        animation-delay: 0.3s;
    }
    
    .payment-option:has(input:checked) {
        border-color: var(--primary) !important;
        background: rgba(45, 106, 79, 0.05);
    }
    .payment-option:hover {
        border-color: var(--primary);
    }
</style>

<script>
    // VERSION: 2024-12-09-v3 - Fixed cart sync and order flow
    console.log('=== CHECKOUT PAGE LOADED - VERSION 2024-12-09-v3 ===');
    
    const cart = JSON.parse(localStorage.getItem("checkedProducts")) || [];
    const itemsContainer = document.getElementById('checkout-items');
    let subtotal = 0;
    const shippingFee = 100; // Base shipping fee in PHP
    let currentUserId = null;

    // Check auth status to pre-fill info
    document.addEventListener('DOMContentLoaded', async () => {
        if (cart.length === 0) {
            window.location.href = '@Url.Action("Index", "Cart")';
            return;
        }
        
        try {
            const response = await fetch('/api/auth/current');
            const result = await response.json();
            if (result.success && result.data) {
                currentUserId = result.data.id;
                const nameParts = (result.data.name || '').split(' ');
                document.getElementById('fname').value = nameParts[0] || '';
                document.getElementById('lname').value = nameParts.slice(1).join(' ') || '';
                document.getElementById('email').value = result.data.email || '';
                
                // Sync selected items to backend cart
                await syncCart();
            } else {
                // User is not logged in - show login modal
                showAuthModal();
            }
        } catch (e) {
            console.log("Auth check error:", e);
            showAuthModal();
        }
        
        renderSummary();
    });
    
    function showAuthModal() {
        document.getElementById('auth-cart-count').textContent = cart.length;
        document.getElementById('auth-modal').style.display = 'flex';
    }

    async function syncCart() {
        if (cart.length === 0) return;
        
        try {
            // First, clear the backend cart to ensure fresh sync with selected items only
            await fetch('/api/cart/clear', { method: 'POST' });
            
            // Then add each selected item with the correct quantity
            for (const item of cart) {
                if (item.id) {
                    const response = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'productId=' + encodeURIComponent(item.id) + '&quantity=' + encodeURIComponent(item.amount)
                    });
                    
                    if (!response.ok) {
                        console.error('Failed to sync item:', item.name);
                    }
                }
            }
            console.log('Cart synced successfully with', cart.length, 'selected items');
        } catch (error) {
            console.error('Cart sync error:', error);
            // Don't throw - we can still proceed with local cart data
        }
    }

    function renderSummary() {
        itemsContainer.innerHTML = '';
        subtotal = 0;
        
        cart.forEach(item => {
            subtotal += item.totalPrice;
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;';
            div.innerHTML = `
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                    <div style="position: relative;">
                        <img src="${item.img}" onerror="this.src='/Content/Images/placeholder.jpg'" style="width: 45px; height: 45px; object-fit: contain; background: #f9fafb; border-radius: var(--radius-sm);">
                        <span style="position: absolute; top: -6px; right: -6px; background: var(--primary); color: white; font-size: 0.65rem; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">${item.amount}</span>
                    </div>
                    <div>
                        <span style="font-size: 0.875rem; font-weight: 500;">${item.name}</span>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">\u20B1${item.price.toFixed(2)} each</p>
                    </div>
                </div>
                <span style="font-weight: 600; font-size: 0.9rem;">\u20B1${item.totalPrice.toFixed(2)}</span>
            `;
            itemsContainer.appendChild(div);
        });

        // Calculate shipping - free if over 1500
        const actualShipping = subtotal >= 1500 ? 0 : shippingFee;
        const tax = subtotal * 0.12; // 12% VAT
        const total = subtotal + actualShipping + tax;

        document.getElementById('chk-subtotal').textContent = `\u20B1${subtotal.toFixed(2)}`;
        document.getElementById('chk-shipping').textContent = actualShipping === 0 ? 'FREE' : `\u20B1${actualShipping.toFixed(2)}`;
        document.getElementById('chk-shipping').style.color = actualShipping === 0 ? '#166534' : '';
        document.getElementById('chk-tax').textContent = `\u20B1${tax.toFixed(2)}`;
        document.getElementById('chk-total').textContent = `\u20B1${total.toFixed(2)}`;
    }

    // Place Order Logic - Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        const placeOrderBtn = document.getElementById('place-order-btn');
        if (!placeOrderBtn) {
            console.error('[Checkout] ERROR: place-order-btn not found!');
            return;
        }
        console.log('[Checkout] Button found, attaching click handler');
        
        placeOrderBtn.addEventListener('click', async function() {
            const btn = this;
            const errorDiv = document.getElementById('checkout-error');
            errorDiv.style.display = 'none';

            // Validation
            const fname = document.getElementById('fname').value.trim();
            const lname = document.getElementById('lname').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const barangay = document.getElementById('barangay').value.trim();
            const city = document.getElementById('city').value.trim();
            const province = document.getElementById('province').value;
            const zip = document.getElementById('zip').value.trim();
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

            if (!fname || !lname || !email || !phone || !address || !barangay || !city || !province || !zip) {
                document.getElementById('error-message').textContent = "Please fill in all required fields.";
                errorDiv.style.display = 'block';
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Validate phone number (PH format)
            if (!/^9\d{9}$/.test(phone.replace(/\s/g, ''))) {
                document.getElementById('error-message').textContent = "Please enter a valid Philippine mobile number (9XX XXX XXXX).";
                errorDiv.style.display = 'block';
                return;
            }

            btn.innerHTML = '<i class="ph-bold ph-spinner" style="animation: spin 1s infinite linear;"></i> Processing...';
            btn.disabled = true;

            try {
                console.log('[Checkout] Step 1: Starting checkout process...');
                console.log('[Checkout] Step 2: Syncing cart to backend...');
                await syncCart();
                console.log('[Checkout] Step 3: Cart synced successfully');

                const fullAddress = `${address}, Brgy. ${barangay}, ${city}, ${province} ${zip}`;
                
                const payload = {
                    CustomerName: fname + ' ' + lname,
                    CustomerEmail: email,
                    Phone: '+63' + phone.replace(/\s/g, ''),
                    ShippingAddress: fullAddress,
                    City: city,
                    State: province,
                    ZipCode: zip
                };
                console.log('[Checkout] Step 4: Payload prepared:', payload);

                console.log('[Checkout] Step 5: Calling /api/orders/checkout...');
                const response = await fetch('/api/orders/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                console.log('[Checkout] Step 6: Response received, status:', response.status);

                const result = await response.json();
                console.log('[Checkout] Step 7: API result:', result);

                if (result.success) {
                    console.log('[Checkout] SUCCESS! Order ID:', result.data.orderId);
                    document.getElementById('order-id-display').textContent = result.data.orderId;
                    document.getElementById('success-modal').style.display = 'flex';
                    
                    // Clear the checked out items from local storage
                    localStorage.removeItem("checkedProducts");
                    
                    // Also clear user-specific cart if logged in
                    if (currentUserId) {
                        localStorage.removeItem(`cart_user_${currentUserId}`);
                    } else {
                        localStorage.removeItem('cart_guest');
                    }
                    
                    window.dispatchEvent(new Event('cartUpdated'));
                } else {
                    console.log('[Checkout] FAILED: API returned success=false');
                    throw new Error(result.message || 'Order failed');
                }

            } catch (error) {
                console.error('Checkout error:', error);
                let errorMsg = error.message || 'An unexpected error occurred';
                
                // Provide more helpful error messages
                if (errorMsg.toLowerCase().includes('cart is empty')) {
                    errorMsg = 'Your cart appears to be empty. Please add items to your cart and try again.';
                } else if (errorMsg.toLowerCase().includes('failed to fetch')) {
                    errorMsg = 'Network error. Please check your internet connection and try again.';
                }
                
                document.getElementById('error-message').textContent = errorMsg;
                errorDiv.style.display = 'block';
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                btn.innerHTML = '<i class="ph-bold ph-check-circle" style="margin-right: 0.5rem;"></i> Place Order';
                btn.disabled = false;
            }
        });
    });

    window.finishCheckout = function() {
        // Clear all cart-related localStorage
        localStorage.removeItem("checkedProducts");
        if (currentUserId) {
            localStorage.removeItem(`cart_user_${currentUserId}`);
        } else {
            localStorage.removeItem('cart_guest');
        }
        window.dispatchEvent(new Event('cartUpdated'));
    };
</script>
