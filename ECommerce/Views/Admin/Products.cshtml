@{
    ViewBag.Title = "Manage Products";
}

<div style="display: flex; gap: 2rem;">
    <!-- Sidebar -->
    @Html.Partial("_AdminSidebar")

    <!-- Main Content -->
    <div style="flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1 style="font-size: 2rem; margin-bottom: 0.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Products</h1>
                <p style="color: var(--text-muted);">Manage your product inventory</p>
            </div>
            <button class="btn btn-primary" onclick="openModal()">
                <i class="ph-bold ph-plus" style="margin-right: 0.5rem;"></i> Add New Product
            </button>
        </div>

        <div class="card" style="padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                <div class="form-group" style="margin: 0; width: 300px;">
                    <div style="position: relative;">
                        <input type="text" id="search-input" class="form-control" placeholder="Search products..." style="padding-left: 2.5rem;" oninput="filterProducts()">
                        <i class="ph ph-magnifying-glass" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <select id="filter-type" class="form-control" style="width: 150px;" onchange="filterProducts()">
                        <option value="All">All Categories</option>
                        <option value="Vegetable">Vegetable</option>
                        <option value="Fruit">Fruit</option>
                        <option value="Meat">Meat</option>
                    </select>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border); text-align: left;">
                        <th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500; width: 80px;">Image</th>
                        <th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Product Name</th>
                        <th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Category</th>
                        <th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Price</th>
                        <th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500;">Stock</th>
                        <th style="padding: 1rem 0; color: var(--text-muted); font-weight: 500; text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="products-body">
                    <tr><td colspan="6" style="padding: 3rem; text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div id="product-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 550px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
        <h2 id="modal-title" style="margin-bottom: 1.5rem;">Add New Product</h2>
        <form id="product-form" enctype="multipart/form-data">
            <input type="hidden" id="prod-id">
            <input type="hidden" id="prod-existing-image">
            <div class="form-group">
                <label class="form-label">Product Name</label>
                <input type="text" id="prod-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select id="prod-category" class="form-control">
                    <option value="Vegetable">Vegetable</option>
                    <option value="Fruit">Fruit</option>
                    <option value="Meat">Meat</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label">Price (₱)</label>
                    <input type="number" id="prod-price" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Stock Quantity</label>
                    <input type="number" id="prod-stock" class="form-control" required value="0" min="0">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Product Image</label>
                <div id="image-upload-area" style="border: 2px dashed var(--border); border-radius: var(--radius-md); padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--bg-alt);" onclick="document.getElementById('prod-image-file').click()">
                    <input type="file" id="prod-image-file" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <div id="image-preview" style="display: none; margin-bottom: 1rem;">
                        <img id="preview-img" src="" style="max-width: 150px; max-height: 150px; object-fit: contain; border-radius: var(--radius-sm);">
                    </div>
                    <div id="upload-placeholder">
                        <i class="ph ph-cloud-arrow-up" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem;"></i>
                        <p style="color: var(--text-muted); margin-bottom: 0.25rem;">Click to upload image</p>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">PNG, JPG, GIF up to 5MB</p>
                    </div>
                </div>
                <button type="button" id="remove-image-btn" onclick="removeImage()" style="display: none; margin-top: 0.5rem;" class="btn btn-outline" style="font-size: 0.875rem;">
                    <i class="ph ph-x" style="margin-right: 0.25rem;"></i> Remove Image
                </button>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="prod-desc" class="form-control" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="button" class="btn btn-outline" onclick="closeModal()" style="flex: 1;">Cancel</button>
                <button type="submit" class="btn btn-primary" id="save-btn" style="flex: 1;">Save Product</button>
            </div>
        </form>
    </div>
</div>

<style>
    #image-upload-area:hover {
        border-color: var(--primary);
        background: rgba(45, 106, 79, 0.05);
    }
    #image-upload-area.dragover {
        border-color: var(--primary);
        background: rgba(45, 106, 79, 0.1);
    }
</style>

<script>
    let products = [];
    let selectedImageFile = null;
    const tbody = document.getElementById("products-body");
    const modal = document.getElementById("product-modal");
    
    document.addEventListener("DOMContentLoaded", function() {
        loadProducts();
        
        // Check if we should open the add modal (from dashboard)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('openAddModal') === 'true') {
            openModal();
            // Clean the URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // Setup drag and drop for image upload
        const uploadArea = document.getElementById('image-upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleImageFile(e.dataTransfer.files[0]);
            }
        });
    });

    function handleImageSelect(event) {
        if (event.target.files.length > 0) {
            handleImageFile(event.target.files[0]);
        }
    }
    
    function handleImageFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB');
            return;
        }
        
        selectedImageFile = file;
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('upload-placeholder').style.display = 'none';
            document.getElementById('remove-image-btn').style.display = 'inline-flex';
        };
        reader.readAsDataURL(file);
    }
    
    function removeImage() {
        selectedImageFile = null;
        document.getElementById('prod-image-file').value = '';
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('upload-placeholder').style.display = 'block';
        document.getElementById('remove-image-btn').style.display = 'none';
        document.getElementById('prod-existing-image').value = '';
    }

    async function loadProducts() {
        try {
            const response = await fetch('/api/products');
            const result = await response.json();
            
            if (result.success) {
                products = result.data;
                renderProducts(products);
            } else {
                tbody.innerHTML = `<tr><td colspan="6" style="padding: 3rem; text-align: center; color: red;">${result.message}</td></tr>`;
            }
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="6" style="padding: 3rem; text-align: center; color: red;">Error loading products.</td></tr>`;
        }
    }

    function renderProducts(data) {
        tbody.innerHTML = "";
        
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="padding: 3rem; text-align: center; color: var(--text-muted);">No products found.</td></tr>`;
            return;
        }

        data.forEach((prod) => {
            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid var(--border)";
            const stockValue = prod.StockQuantity !== undefined ? prod.StockQuantity : 0;
            tr.innerHTML = `
                <td style="padding: 1rem 0;">
                    <img src="${prod.Image || '/Content/Images/placeholder.jpg'}" onerror="this.src='/Content/Images/placeholder.jpg'" style="width: 50px; height: 50px; object-fit: contain; border-radius: var(--radius-sm); background: #f9fafb;">
                </td>
                <td style="padding: 1rem 0; font-weight: 600;">${prod.Name}</td>
                <td style="padding: 1rem 0;">${prod.Type}</td>
                <td style="padding: 1rem 0;">₱${prod.Price.toFixed(2)}</td>
                <td style="padding: 1rem 0;">
                    <span style="${stockValue > 0 ? 'background: #dcfce7; color: #166534;' : 'background: #fee2e2; color: #991b1b;'} padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 500;">
                        ${stockValue > 0 ? stockValue + ' In Stock' : 'Out of Stock'}
                    </span>
                </td>
                <td style="padding: 1rem 0; text-align: right;">
                    <button class="icon-btn" onclick="editProduct(${prod.Id})"><i class="ph-bold ph-pencil-simple"></i></button>
                    <button class="icon-btn" onclick="deleteProduct(${prod.Id})" style="color: #ef4444;"><i class="ph-bold ph-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterProducts() {
        const query = document.getElementById("search-input").value.toLowerCase();
        const type = document.getElementById("filter-type").value;
        
        let filtered = products.filter(p => {
            const matchesSearch = p.Name.toLowerCase().includes(query);
            const matchesType = type === "All" || p.Type === type;
            return matchesSearch && matchesType;
        });
        
        renderProducts(filtered);
    }

    window.openModal = function() {
        modal.setAttribute("style", "display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center;");
        document.getElementById("modal-title").textContent = "Add New Product";
        document.getElementById("product-form").reset();
        document.getElementById("prod-id").value = "";
        document.getElementById("prod-existing-image").value = "";
        document.getElementById("prod-stock").value = "0";
        selectedImageFile = null;
        // Reset image preview
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('upload-placeholder').style.display = 'block';
        document.getElementById('remove-image-btn').style.display = 'none';
        document.getElementById('prod-image-file').value = '';
    };

    window.closeModal = function() {
        modal.style.display = "none";
    };

    window.editProduct = function(id) {
        const prod = products.find(p => p.Id === id);
        if (!prod) return;
        
        openModal();
        document.getElementById("modal-title").textContent = "Edit Product";
        document.getElementById("prod-id").value = prod.Id;
        document.getElementById("prod-name").value = prod.Name;
        document.getElementById("prod-category").value = prod.Type;
        document.getElementById("prod-price").value = prod.Price;
        document.getElementById("prod-stock").value = prod.StockQuantity !== undefined ? prod.StockQuantity : 0;
        document.getElementById("prod-desc").value = prod.Description || "";
        document.getElementById("prod-existing-image").value = prod.Image || "";
        
        // Show existing image in preview
        if (prod.Image) {
            document.getElementById('preview-img').src = prod.Image;
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('upload-placeholder').style.display = 'none';
            document.getElementById('remove-image-btn').style.display = 'inline-flex';
        }
    };

    window.deleteProduct = async function(id) {
        if(confirm("Are you sure you want to delete this product?")) {
            try {
                const response = await fetch(`/api/products/delete/${id}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    loadProducts(); // Reload
                } else {
                    alert("Failed to delete: " + result.message);
                }
            } catch (e) {
                alert("Error deleting product");
            }
        }
    };

    document.getElementById("product-form").onsubmit = async function(e) {
        e.preventDefault();
        
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        const id = document.getElementById("prod-id").value;
        const existingImage = document.getElementById("prod-existing-image").value;
        
        try {
            // Create FormData for multipart form submission
            const formData = new FormData();
            formData.append('Name', document.getElementById("prod-name").value);
            formData.append('Type', document.getElementById("prod-category").value);
            formData.append('Price', parseFloat(document.getElementById("prod-price").value));
            formData.append('StockQuantity', parseInt(document.getElementById("prod-stock").value) || 0);
            formData.append('Description', document.getElementById("prod-desc").value);
            
            if (selectedImageFile) {
                formData.append('ImageFile', selectedImageFile);
            } else if (existingImage) {
                formData.append('Image', existingImage);
            }
            
            let url = '/api/products/create';
            if (id) {
                url = '/api/products/update';
                formData.append('Id', parseInt(id));
            }

            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (result.success) {
                closeModal();
                loadProducts();
            } else {
                alert("Operation failed: " + result.message);
            }
        } catch (e) {
            alert("Error saving product");
            console.error(e);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Product';
        }
    };
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
</script>
